<div class="annonce-view-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Chargement de l'annonce...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <div class="error-icon">
      <span class="material-icons">error</span>
    </div>
    <h2>{{ error }}</h2>
    <button class="btn btn-primary" (click)="goBack()">
      <span class="material-icons">arrow_back</span>
      Retour
    </button>
  </div>

  <!-- Annonce Details -->
  <div *ngIf="annonce && !isLoading" class="annonce-details">
    
    <!-- Header with actions -->
    <div class="annonce-header">
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="goBack()">
          <span class="material-icons">arrow_back</span>
          Retour
        </button>
        <button class="btn btn-primary" (click)="editAnnonce()">
          <span class="material-icons">edit</span>
          Modifier
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="annonce-content">
      
      <!-- Image Gallery Section -->
      <div class="image-section">
        <div class="main-image-container">
          <div *ngIf="getCurrentImage()" class="main-image">
            <img [src]="getCurrentImage()!" [alt]="annonce.titre">
            
            <!-- Navigation arrows for multiple images -->
            <div *ngIf="hasMultipleImages()" class="image-nav">
              <button class="nav-btn prev" (click)="previousImage()">
                <span class="material-icons">chevron_left</span>
              </button>
              <button class="nav-btn next" (click)="nextImage()">
                <span class="material-icons">chevron_right</span>
              </button>
            </div>
          </div>
          
          <!-- Default placeholder if no images -->
          <div *ngIf="!getCurrentImage()" class="default-image">
            <span class="material-icons">{{ annonce.typeBien === 'VILLA' ? 'villa' : 'home' }}</span>
          </div>
        </div>
        
        <!-- Thumbnail Gallery -->
        <div *ngIf="annonce.images && annonce.images.length > 1" class="image-thumbnails">
          <div 
            *ngFor="let image of annonce.images; let i = index"
            class="thumbnail"
            [class.active]="i === currentImageIndex"
            (click)="selectImage(i)">
            <img [src]="image" [alt]="'Image ' + (i + 1)">
          </div>
        </div>
      </div>

      <!-- Info Section -->
      <div class="info-section">
        
        <!-- Title and Basic Info -->
        <div class="title-section">
          <h1>{{ annonce.titre }}</h1>
          <div class="basic-info">
            <span class="price">{{ formatPrice(annonce.prix) }} <span class="currency">TND</span></span>
            <div class="badges">
              <span class="badge transaction-badge">{{ getTypeTransactionDisplay(annonce.typeTransaction) }}</span>
              <span class="badge type-badge">{{ getTypeBienDisplay(annonce.typeBien) }}</span>
              <span class="badge status-badge" [ngClass]="'status-' + annonce.status.toLowerCase()">
                {{ getStatusDisplay(annonce.status) }}
              </span>
            </div>
          </div>
        </div>

        <!-- Location -->
        <div class="location-section">
          <div class="location">
            <span class="material-icons">location_on</span>
            <span>
              <ng-container *ngIf="annonce.adresse">{{ annonce.adresse }}, </ng-container>
              {{ annonce.ville }}
              <ng-container *ngIf="annonce.codePostal"> {{ annonce.codePostal }}</ng-container>
            </span>
          </div>
        </div>

        <!-- Description -->
        <div class="description-section">
          <h2><span class="material-icons">description</span> Description</h2>
          <p class="description">{{ annonce.description }}</p>
        </div>

        <!-- Property Features -->
        <div class="features-section">
          <h2><span class="material-icons">home</span> Caractéristiques</h2>
          <div class="features-grid">
            <div class="feature-item" *ngIf="annonce.surface">
              <span class="material-icons">square_foot</span>
              <span class="feature-label">Surface</span>
              <span class="feature-value">{{ annonce.surface }}m²</span>
            </div>
            <div class="feature-item" *ngIf="annonce.nombreChambres">
              <span class="material-icons">bed</span>
              <span class="feature-label">Chambres</span>
              <span class="feature-value">{{ annonce.nombreChambres }}</span>
            </div>
            <div class="feature-item" *ngIf="annonce.nombreSallesBain">
              <span class="material-icons">bathtub</span>
              <span class="feature-label">Salles de bain</span>
              <span class="feature-value">{{ annonce.nombreSallesBain }}</span>
            </div>
            <div class="feature-item" *ngIf="annonce.etage != null">
              <span class="material-icons">layers</span>
              <span class="feature-label">Étage</span>
              <span class="feature-value">{{ annonce.etage }}</span>
            </div>
          </div>
        </div>

        <!-- Amenities -->
        <div class="amenities-section" *ngIf="annonce.garage || annonce.jardin || annonce.piscine || annonce.climatisation || annonce.ascenseur">
          <h2><span class="material-icons">star</span> Équipements</h2>
          <div class="amenities-list">
            <div class="amenity-item" *ngIf="annonce.garage">
              <span class="material-icons">garage</span>
              <span>Garage</span>
            </div>
            <div class="amenity-item" *ngIf="annonce.jardin">
              <span class="material-icons">grass</span>
              <span>Jardin</span>
            </div>
            <div class="amenity-item" *ngIf="annonce.piscine">
              <span class="material-icons">pool</span>
              <span>Piscine</span>
            </div>
            <div class="amenity-item" *ngIf="annonce.climatisation">
              <span class="material-icons">ac_unit</span>
              <span>Climatisation</span>
            </div>
            <div class="amenity-item" *ngIf="annonce.ascenseur">
              <span class="material-icons">elevator</span>
              <span>Ascenseur</span>
            </div>
          </div>
        </div>

        <!-- Contact Information -->
        <div class="contact-section">
          <h2><span class="material-icons">contact_phone</span> Contact</h2>
          <div class="contact-info">
            <div class="contact-item">
              <span class="material-icons">person</span>
              <span>{{ annonce.nomContact }}</span>
            </div>
            <div class="contact-item">
              <span class="material-icons">phone</span>
              <span>{{ annonce.telephoneContact }}</span>
            </div>
            <div class="contact-item" *ngIf="annonce.emailContact">
              <span class="material-icons">email</span>
              <span>{{ annonce.emailContact }}</span>
            </div>
          </div>
        </div>

        <!-- Metadata -->
        <div class="metadata-section">
          <div class="metadata-item">
            <span class="label">Créé le:</span>
            <span class="value">{{ formatDate(annonce.dateCreation) }}</span>
          </div>
          <div class="metadata-item" *ngIf="annonce.dateMiseAJour">
            <span class="label">Modifié le:</span>
            <span class="value">{{ formatDate(annonce.dateMiseAJour) }}</span>
          </div>
          <div class="metadata-item" *ngIf="annonce.dateExpiration">
            <span class="label">Expire le:</span>
            <span class="value">{{ formatDate(annonce.dateExpiration) }}</span>
          </div>
        </div>

        <!-- Rating and Comments Section -->
        <div class="comments-section">
          <h2><span class="material-icons">chat_bubble</span> Évaluations et Commentaires</h2>
          
          <!-- Rating Summary -->
          <div class="rating-summary" *ngIf="commentStats">
            <div class="average-rating">
              <div class="rating-stars">
                <span 
                  *ngFor="let star of [1, 2, 3, 4, 5]" 
                  class="material-icons star" 
                  [ngClass]="{'filled': star <= getAverageRatingRounded()}">
                  star
                </span>
              </div>
              <span class="rating-text">
                {{ commentStats.averageRating | number:'1.1-1' }} / 5.0
                ({{ commentStats.commentCount }} 
                {{ commentStats.commentCount === 1 ? 'évaluation' : 'évaluations' }})
              </span>
            </div>
          </div>

          <!-- Add Comment Form (for authenticated users) -->
          <div class="add-comment-form" *ngIf="canComment()">
            <h3>Laisser un commentaire</h3>
            <div class="rating-input">
              <label>Note :</label>
              <div class="rating-stars-input">
                <span 
                  *ngFor="let star of [1, 2, 3, 4, 5]" 
                  class="material-icons star-input" 
                  [ngClass]="{'selected': star <= selectedRating}"
                  (click)="setRating(star)">
                  star
                </span>
              </div>
            </div>
            
            <div class="comment-input">
              <label for="commentText">Commentaire :</label>
              <textarea 
                id="commentText"
                [(ngModel)]="newComment"
                placeholder="Partagez votre expérience..."
                maxlength="1000"
                rows="4">
              </textarea>
              <div class="char-count">{{ newComment?.length || 0 }}/1000</div>
            </div>
            
            <div class="form-actions">
              <button 
                class="btn btn-primary"
                (click)="submitComment()"
                [disabled]="!canSubmitComment()"
                [class.loading]="isSubmittingComment">
                <span class="material-icons" *ngIf="!isSubmittingComment">send</span>
                <span class="material-icons spinning" *ngIf="isSubmittingComment">refresh</span>
                {{ isSubmittingComment ? 'Envoi en cours...' : 'Publier' }}
              </button>
            </div>
          </div>

          <!-- Debug Information (remove in production) -->
          <div class="debug-info" *ngIf="authService.isAuthenticated" style="background: #f0f0f0; padding: 1rem; margin: 1rem 0; border-radius: 8px; font-size: 0.85rem;">
            <strong>Debug Info:</strong><br>
            - User authenticated: {{ authService.isAuthenticated }}<br>
            - User type: {{ authService.currentUser?.userType }}<br>
            - Can comment: {{ canComment() }}<br>
            - Comments loaded: {{ comments?.length || 0 }}<br>
            - Loading comments: {{ isLoadingComments }}<br>
            - Should show comments: {{ shouldShowComments() }}
          </div>

          <!-- Loading State -->
          <div *ngIf="isLoadingComments" class="comments-loading">
            <div class="loading-spinner"></div>
            <p>Chargement des commentaires...</p>
          </div>

          <!-- Comments List -->
          <div class="comments-list" *ngIf="!isLoadingComments && comments && comments.length > 0">
            <h3>Commentaires ({{ comments.length }})</h3>
            <div class="comment-item" *ngFor="let comment of comments; trackBy: trackByCommentId">
              <div class="comment-header">
                <div class="comment-author">
                  <span class="material-icons">account_circle</span>
                  <span class="author-name">{{ comment.userName }}</span>
                  <span class="author-type" [class]="comment.userType.toLowerCase()">{{ getUserTypeDisplay(comment.userType) }}</span>
                </div>
                <div class="comment-rating" *ngIf="comment.rating > 0">
                  <span 
                    *ngFor="let star of [1, 2, 3, 4, 5]" 
                    class="material-icons star-small" 
                    [ngClass]="{'filled': star <= comment.rating}">
                    star
                  </span>
                </div>
              </div>
              <div class="comment-content">
                <div class="comment-text">{{ comment.content }}</div>
                <div class="comment-meta">
                  <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
                  <span class="comment-rating" *ngIf="comment.rating > 0">
                    Note: {{ comment.rating }}/5
                  </span>
                </div>
              </div>
              <div class="comment-footer">
                <!-- Reply Button for Agencies (only if they own the annonce) -->
                <button 
                  *ngIf="canReply()" 
                  class="btn-reply" 
                  (click)="startReply(comment.id)"
                  [disabled]="isSubmittingReply">
                  <span class="material-icons">reply</span>
                  Répondre
                </button>
                
                <!-- Reply Form -->
                <div *ngIf="replyingToComment === comment.id" class="reply-form">
                  <div class="reply-header">
                    <span class="material-icons">reply</span>
                    <span>Répondre à {{ comment.userName }}</span>
                  </div>
                  <div class="reply-input-container">
                    <textarea 
                      [(ngModel)]="replyContent"
                      placeholder="Écrivez votre réponse..."
                      class="reply-textarea"
                      rows="3"
                      [disabled]="isSubmittingReply">
                    </textarea>
                  </div>
                  <div class="reply-actions">
                    <button class="btn btn-sm btn-secondary" 
                            (click)="cancelReply()"
                            [disabled]="isSubmittingReply">
                      <span class="material-icons">close</span>
                      Annuler
                    </button>
                    <button class="btn btn-sm btn-primary" 
                            (click)="submitReply(comment.id)"
                            [disabled]="!replyContent?.trim() || isSubmittingReply">
                      <span class="material-icons" *ngIf="!isSubmittingReply">send</span>
                      <span class="material-icons rotating" *ngIf="isSubmittingReply">refresh</span>
                      {{ isSubmittingReply ? 'Envoi...' : 'Envoyer' }}
                    </button>
                  </div>
                </div>

                <!-- Show replies if any -->
                <div class="replies-section" *ngIf="comment.replies && comment.replies.length > 0">
                  <div class="replies-header">
                    <span class="material-icons">subdirectory_arrow_right</span>
                    <span>{{ comment.replies.length }} réponse(s)</span>
                  </div>
                  <div *ngFor="let reply of comment.replies" class="reply-item">
                    <div class="reply-author">
                      <span class="material-icons">business</span>
                      <span class="author-name">{{ reply.userName }}</span>
                      <span class="agency-badge">Agence</span>
                    </div>
                    <p class="reply-content">{{ reply.content }}</p>
                    <p class="reply-date">{{ formatDate(reply.createdAt) }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- No Comments Message -->
          <div class="no-comments" *ngIf="comments && comments.length === 0">
            <span class="material-icons">chat_bubble_outline</span>
            <p>Aucun commentaire pour le moment. Soyez le premier à donner votre avis !</p>
          </div>

          <!-- Loading Comments -->
          <div class="loading-comments" *ngIf="isLoadingComments">
            <div class="loading-spinner-small"></div>
            <p>Chargement des commentaires...</p>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>